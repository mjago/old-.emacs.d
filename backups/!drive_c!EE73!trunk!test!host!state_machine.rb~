
class StateMachine
  def initialize
    @state = :prepare_message
  end

  def process_state
    case @state
    when :prepare_message
      @message = fetch_next_message
      @state = :prepare_expected_result
    when :prepare_expected_result
      @expected_result = fetch_expected_result
      @state = :send_command
    when :send_command
      @serial.send_command
      @state = :await_result
    when :await_result
      if result_in?
        fetch_result
        @state = :process_result
      end
    when :process_result
      log_result
      process_result
      @state = :prepare_message
    else
      puts "ERROR! Unknown state in process_state"
      exit 1
    end
  end
end
