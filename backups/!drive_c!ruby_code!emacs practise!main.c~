
#ifndef TEST
  #include "p18f8720.h"
#else
//  #include "inttypes.h"
#endif

#ifdef TESTING
	#include "testing.h"
#endif

#include "global_vars.h"
#include "adc.h"
#include "power.h"
#include "cfr.h"
#include "defs.h"
#include "infusion.h"
#include "serial.h"
#include "technician.h"
#include "timers.h"
#include "main.h"
#include "tests.h"
#include "flowcheck.h"
#include "stackchecks.h"
#include "menucontrol.h"
#include "calculations.h"
#include "bolus.h"

//  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .

/** \ingroup control
  * main() is the program main loop.
  */

void mainLoop(void)
  {
  for(;;)
    {
    testMainStack();                                // Ensure stack == MAIN_STACK_DEPTH
    resetWatchdog();

    MAIN_LOOP_ZI_TESTS;                            	// Main loop unit-tests insertion point

    checkStackContainment();
    cfrScanTest();
    checkAnalogsReady();
    secCheckComms();
    checkCharger();                                 // Check charge / battery state
    softwareControlCheck();
    branchCheck();
    checkLidOpen();
    fingerPlateCheck();
    startEnableCheck();
    calcVI();
    checkControl();
    checkBolus();
    check_infusion_progress();                      // check neoi and eoi points
    serviceMenus();
    processTimers();
    processQueues();
    checkTechMode();
    flowCheckMain();                                // Verify top main program flow position
    }
	}

//  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .

#pragma code
