require File.expand_path(File.join(File.dirname(__FILE__),'version'))

class BuildHeaderFooter
	
	def build(type, build_time = :not_provided)
		@build_time = build_time
		[:root, :pri, :sec].each do |depth|
			@template = get_template(type, depth)
			case type
				when :header 
					insert_version
				when :footer
					insert_version
					insert_build_time
				else
					puts "ERROR! unknown type in BuildHeaderFooter::build!"
					exit 1
			end
			write_file(type, depth)
		end	
	end
	
	def insert_version
		@template.collect! do |line|
			line.gsub('VERSION_GOES_HERE',get_version)
		end
	end
	
	def insert_build_time
		if @build_time == :not_provided
			puts "ERROR! build time not provided in BuildHeaderFooter::insert_build_time!"
			exit 1
		end
		@template.collect! do |line|
			line.gsub('BUILD_TIME_GOES_HERE',@build_time)
		end
	end
	
	def write_file(type, depth)
		out_file_root = File.expand_path(File.join(File.dirname(__FILE__),'..','includes'))
		out_file = ''
		case depth
			when :root
				out_file_root = out_file_root
			when :pri
				out_file_root = File.join(out_file_root,'pri')
			when :sec
				out_file_root = File.join(out_file_root,'sec')
			else
				puts "ERROR unknown depth #{depth} in BuildHeaderFooter::write_file"
				exit 1
		end
		case type
			when :header
				out_file = File.join(out_file_root,"htmlHeader.html")
			when :footer
				out_file = File.join(out_file_root,"htmlFooter.html")
			else
				puts "ERROR unknown type \"#{type}\" in BuildHeaderFooter::write_file"
				exit 1
		end
				
		f = File.open(out_file,'w')
		if f == nil
			puts "ERROR opening #{type} file to write in BuildHeaderFooter::write_file"
			exit 1
		end
		
		@template.each do |line|
			f.puts(line)
		end
		f.close
		f = nil
	end
	
	def get_version
		Version.new.get_version
	end
	
	def get_template(type, depth)
		in_file_root = File.expand_path(File.join(File.dirname(__FILE__),'templates'))
		case depth
			when :root
				@template_prefix = '_html_root_'
			when :pri
				@template_prefix = '_html_pri_'
			when :sec
				@template_prefix = '_html_sec_'
			else
				puts "ERROR! Can't find template 'depth' #{depth} in BuildHeaderFooter::get_template!"
				exit 1
		end
		case type
			when :header
				f = File.open(File.join(in_file_root, "#{@template_prefix}Header.html"),'r')
			when :footer
				f = File.open(File.join(in_file_root, "#{@template_prefix}Footer.html"),'r')
			else 
				puts "ERROR! Can't find template in BuildHeaderFooter::get_template!"
				exit 1
		end
			
		f.readlines
		
		#~ @f = File.open(File.expand_path(File.join(File.dirname(__FILE__),'templates',"#{template_name}"))
	 
	end
end
	
#~ require 'test/unit'
#~ class Test_BuildHeaderFooter < Test::Unit::TestCase
	#~ def setup
		#~ @hf = BuildHeaderFooter.new
	#~ end
	
	#~ def teardown
		#~ @hf = nil
	#~ end
	
	#~ def test_get_template_undefined_type
		#~ assert_raise(SystemExit) { (@hf.get_template(:none)) }
	#~ end	
	
	#~ def test_get_template_header
		#~ assert_equal "[\"\\n\", \"<!-- AUTOGENERATED! DO NOT MODIFY -->\\n\", \"\\n\", \"<HTML>\\n\", \"\\t<HEAD>\\n\", \"\\t<LINK REL=\\\"SHORTCUT ICON\\\" HREF=\\\"favicon.ico\\\">\\n\", \"\\t<TITLE>Alaris Syringe Pump Software Documentation (VERSION_GOES_HERE)</TITLE>\\n\", \"\\t<META http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=iso-8859-1\\\">\\n\", \"\\t<!DOCTYPE HTML PUBLIC \\\"-//W3C//DTD HTML 4.01 Transitional//EN\\\">\\n\", \"\\t<P align=\\\"center\\\"><LINK href=\\\"docs.css\\\" type=\\\"text/css\\\" rel=\\\"stylesheet\\\"></P>\\n\", \"\\n\", \"<table width=\\\"100%\\\" border=\\\"0\\\">\\n\", \"  <tr>\\n\", \"    <td width=\\\"523\\\" height=\\\"26\\\">&nbsp;</td>\\n\", \"    <td>&nbsp;</td>\\n\", \"    <td width=\\\"1421\\\">&nbsp;</td>\\n\", \"  </tr>\\n\", \"  <tr valign=\\\"top\\\">\\n\", \"    <td><img height=\\\"50\\\" alt=\\\"Alaris Medical Systems\\\" src=\\\"alaris_brand.gif\\\" width=\\\"332\\\" align=\\\"left\\\" border=\\\"0\\\"></td>\\n\", \"    <td width=\\\"50\\\">&nbsp;</td>\\n\", \"    <td>\\n\", \"      <form class=\\\"search\\\" action=\\\"search.php\\\" method=\\\"get\\\">\\n\", \"        <div align=\\\"right\\\"><span class=\\\"search\\\"><u>S</u>earch&nbsp;for&nbsp;&nbsp;\\n\", \"          <input class=\\\"search\\\" type=\\\"text\\\" name=\\\"query\\\" value=\\\"\\\" size=\\\"20\\\" accesskey=\\\"s\\\"/>\\n\", \"          &nbsp;&nbsp; <A class=\\\"qtest\\\"href=\\\"php_info_page.html\\\"><I> <SMALL><span style=\\\"color: #6D7B8D\\\">(requires&nbsp;PHP)</span>\\n\", \"          </SMALL></I> </A> </span> </div>\\n\", \"      </form>\\n\", \"      <P align=\\\"right\\\">&nbsp; </P>\\n\", \"      <div align=\\\"right\\\"></div>\\n\", \"      </td>\\n\", \"  </tr>\\n\", \"  <tr bgcolor=\\\"#CCCCCC\\\">\\n\", \"    <td height=\\\"2\\\" colspan=\\\"3\\\">\\n\", \"      <div align=\\\"center\\\"></div>\\n\", \"\\n\", \"    </td>\\n\", \"  </tr>\\n\", \"</table>\\n\", \"<div align=\\\"center\\\"></div>\\n\", \"<p align=\\\"center\\\"><a class=\\\"qtest\\\" href=\\\"index.html\\\">Home</a>\\n\", \"| <a class=\\\"qtest\\\" href=\\\"table_of_contents_page.html\\\">Table&nbsp;Of&nbsp;Contents</a>\\n\", \"| <a class=\\\"qtest\\\" href=\\\"file_list_page.html\\\"> File&nbsp;List</a>\\n\", \"| <a class=\\\"qtest\\\" href=\\\"further_references_page.html\\\">Further&nbsp;References</a>\\n\", \"  \\t</HEAD>\\n\", \"  </HTML>\\n\"]", @hf.get_template(:header).inspect
	#~ end	
	
	#~ def test_get_template_footer
		#~ assert_equal "[\"\\n\", \"<!-- AUTOGENERATED! DO NOT MODIFY -->\\n\", \"\\n\", \"<p align=\\\"center\\\"><a class=\\\"qtest\\\" href=\\\"index.html\\\">Home</a>\\n\", \"| <a class=\\\"qtest\\\" href=\\\"table_of_contents_page.html\\\">Table&nbsp;Of&nbsp;Contents</a>\\n\", \"| <a class=\\\"qtest\\\" href=\\\"file_list_page.html\\\"> File&nbsp;List</a>\\n\", \"| <a class=\\\"qtest\\\" href=\\\"further_references_page.html\\\">Further&nbsp;References</a>\\n\", \"\\n\", \"<br>\\n\", \"\\n\", \"<TABLE id=\\\"Table2\\\" cellSpacing=\\\"1\\\" cellPadding=\\\"1\\\" width=\\\"300\\\" align=\\\"right\\\" border=\\\"0\\\">\\n\", \"\\n\", \"\\t<TR>\\n\", \"\\t\\t<TD height=\\\"1\\\">\\n\", \"\\t\\t\\t<P align=\\\"center\\\"><a href=\\\"http://www.zi-medical.com\\\"><IMG id=\\\"IMG1\\\" height=\\\"50\\\" alt=\\\"Zi Medical\\\" src=\\\"Zi_logo.jpg\\\" width=\\\"75\\\" align=\\\"middle\\\" border=\\\"0\\\"></P>\\n\", \"\\t\\t</TD>\\n\", \"\\t<TR>\\n\", \"</TABLE>\\n\", \"<br>\\n\", \"<br>\\n\", \"<br>\\n\", \"<a>Alaris Syringe Pump Software Documentation (VERSION_GOES_HERE)</a>\\n\", \"</body>\\n\", \"</html>\\n\", \"\\n\"]", @hf.get_template(:footer).inspect
	#~ end	

	#~ def test_build_file_undefined_type
		#~ assert_raise(SystemExit) { (@hf.build_file(:unknown)) }
	#~ end
	
	#~ def test_get_version    # expect vn.nn
		#~ version = @hf.get_version
		#~ assert version[0..0] == 'v'
		#~ assert version.include?('.')
		#~ assert version.length <= 5
	#~ end

	#~ def write_file_unknown
		#~ assert_raise(SystemExit) { (@hf.write_file(:unknown))}
	#~ end
	
	#~ def write_file_header
		#~ assert @hf.write_file(:header)
	#~ end
	
	#~ def write_file_footer
		#~ assert @hf.write_file(:footer)
	#~ end
	
#~ end
	
if __FILE__ == $0 
	@hf = BuildHeaderFooter.new
	@hf.build(:header)
	@hf.build(:footer,Time.now.to_s)
end

